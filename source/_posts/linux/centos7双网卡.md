---
title: centos7 双网卡配置
date: 2021-08-16 15:59
categories:
- linux
tags:
- network
---
	
	
摘要: centos7双网卡配置
<!-- more -->

## 前言
有个需求是要在服务器上配置双网卡、双IP、双网卡
一般在多网卡的网络访问关系中我们通常根据目标IP地址段来添加静态路由表，在主机系统配置层面这个需求一般都比较简单也不需要使用非常复杂的命令


## 静态路由表和策略路由的区别
通常我们维护静态路由表会手工填写所有IP地址段的路由规则，使用命令或者写入配置文件永久生效，先以Windows/Linux/AIX常用方法为例

```
#Windows静态路由
--键入 route -p add [目标] [mask <网络掩码>] [网关] [metric <度量值>] [if <接口>]
route print
route delete
route -p add 172.16.19.0 mask 255.255.255.0 198.15.0.1

#RHEL静态路由
vi /etc/sysconfig/network
default via 192.168.3.1 dev eth0
10.211.6.0/24 via 192.168.3.1 dev eth0
10.0.0.0/8 via 10.212.52.1 dev eth1

#SuSE静态路由
vi /etc/sysconfig/network/routes
default 192.168.3.1 - -
10.211.6.0 192.168.3.1 255.255.255.0 eth0
10.0.0.0 10.212.52.1 255.0.0.0 eth1

#AIX静态路由
smitty mkroute
172.20.14.0/24 gw 172.23.14.254
```

这种办法针对少量的规则还可以轻松应对，但规则一旦增加麻烦也就接踵而至，网段地址不断变化就必须及时更新路由表，否则其他用户就无法访问。如果可以根据用户访问进来的路径设定策略路由就会方便很多，而rt_tables就是为此而生。


## rt_tables
rt_tables 简单来说就是通过给表的命名使得管理简单化。

大部分人习惯直接将路由表优先级号码直接作为表的名称来使用，这样做的好处是非常直观和简明的表达了表所在优先级的位置，但是当表的优先级结构出现变动时，我们对巨大的路由表的修改就显得很烦琐和费事了。

在/etc/iproute2/目录下,有这么一个文件rt_tables,只要对它进行改动，我们将很容易的完成路由表优先级结构的变动。(数值越小优先级别越高)

当路由表的优先级发生变化的时候，我们只需要编辑/etc/iproute2/rt_tables这个文件就可以直接改变路由表的优先级次序。

```
cat /etc/iproute2/rt_tables

#
# reserved values
#
255    local
254    main
253    default
0    unspec
#
# local
#
#1    inr.ruhep
```

Linux最多可以支持255张路由表，其中有3张表是内置的：
```
表255 本地路由表（Local table） 本地接口地址，广播地址，已及NAT地址都放在这个表。该路由表由系统自动维护，管理员不能直接修改。

表254 主路由表（Main table） 如果没有指明路由所属的表，所有的路由都默认都放在这个表里，一般来说，旧的路由工具（如route）所添加的路由都会加到这个表。一般是普通的路由。

表253 默认路由表 （Default table） 一般来说默认的路由都放在这张表，但是如果特别指明放的也可以是所有的网关路由。
```
表 0 保留。

## 策略性路由应用及分析(iproute2)
### 策略性路由
策略性是指对于IP包的路由是以网络管理员根据需要定下的一些策略为主要依据进行路由的。例如我们可以有这样的策略：“所有来直自网A的包，选择X路径；其他选择Y路径”，或者是“所有TOS为A的包选择路径F；其他选者路径K”。

Cisco 的网络操作系统 (Cisco IOS) 从11.0开始就采用新的策略性路由机制。而Linux是在内核2.1开始采用策略性路由机制的。策略性路由机制与传统的路由算法相比主要是引入了多路由表以及规则的概念。

### 多路由表（multiple Routing Tables）
传统的路由算法是仅使用一张路由表的。但是在有些情形底下，我们是需要使用多路由表的。例如一个子网通过一个路由器与外界相连，路由器与外界有两条线路相连，其中一条的速度比较快，一条的速度比较慢。对于子网内的大多数用户来说对速度并没有特殊的要求，所以可以让他们用比较慢的路由；但是子网内有一些特殊的用户却是对速度的要求比较苛刻，所以他们需要使用速度比较快的路由。如果使用一张路由表上述要求是无法实现的，而如果根据源地址或其它参数，对不同的用户使用不同的路由表，这样就可以大大提高路由器的性能。

### 规则（rule）
规则是策略性的关键性的新的概念。我们可以用自然语言这样描述规则，例如我门可以指定这样的规则：

- 规则一：“所有来自192.16.152.24的IP包，使用路由表10， 本规则的优先级别是1500”

- 规则二：“所有的包，使用路由表253，本规则的优先级别是32767”

我们可以看到，规则包含3个要素：

- 什么样的包，将应用本规则（所谓的SELECTOR，可能是filter更能反映其作用）；

- 符合本规则的包将对其采取什么动作（ACTION），例如用那个表；

- 本规则的优先级别。优先级别越高的规则越先匹配（数值越小优先级别越高）。



## 环境配置
服务器A和B为双网卡，操作系统为 rhel_7.1_64

|网卡显示名称 |	IP地址	| 子网掩码 |	网关 |	备注| 
|---|---|---|---|
|ens192	| 172.31.192.201 |	255.255.255.0 |	172.31.192.1	| 服务器A|
|ens224 |	10.200.88.201 |	255.255.252.0 |	10.200.88.1 |	服务器A |
|ens192	| 172.31.192.202 | 255.255.255.0 | 172.31.192.1 | 服务器B |
|ens224 |	10.200.88.202 | 255.255.252.0 | 10.200.88.1 | 服务器B |
| /	| 172.25.168.44 |	255.255.255.0 |	172.25.168.254 |	接入测试|


### 网络配置，以服务器A为例，注意注释默认网关
vim /etc/sysconfig/network-scripts/ifcfg-ens192
```
DEVICE=ens192
ONBOOT=yes
BOOTPROTO=static
TYPE=Ethernet
IPADDR=172.31.192.201
NETMASK=255.255.255.0
#GATEWAY=172.31.192.1
```

cat /etc/sysconfig/network-scripts/ifcfg-ens224
```
DEVICE=ens224
ONBOOT=yes
BOOTPROTO=static
TYPE=Ethernet
IPADDR=10.200.88.201
NETMASK=255.255.252.0
#GATEWAY=10.200.88.1
```

## 策略路由配置
注意配置名称一定要吻合,
手动添加静态路由, 从哪里进来就从哪里出去, 本机出去的走默认网关
```
#编辑rt_tables ,  自定义, 不重复即可
echo "172 net172 " >> /etc/iproute2/rt_tables
echo "10 net10 " >> /etc/iproute2/rt_tables


#清空net172路由表
ip route flush table net172

# 添加一个路由规则到 net172 表，这条规则是 net172 这个路由表中数据包默认使用源 IP 172.31.192.201 通过 ens192 走网关 172.31.192.1
ip route add default via 172.31.192.1 dev ens192 src 172.31.192.201 table net172

#来自 172.31.192.201 的数据包，使用 net172 路由表的路由规则
ip rule add from 172.31.192.201 table net172

#清空 net10 路由表
ip route flush table net10

#添加一个路由规则到 net10 表，这条规则是 net10 这个路由表中数据包默认使用源 IP 	10.200.88.201 通过 ens224 走网关 	10.200.88.1
ip route add default via 	10.200.88.1 dev ens224 src 	10.200.88.201 table net10

#来自 	10.200.88.201 的数据包，使用 net10 路由表的路由规则
ip rule add from 	10.200.88.201 table net10

#添加默认网关
route add default gw 	10.200.88.1

```

重启会失效！！！


#如果需要自启动生效可以写进配置文件也可以加入rc.local
```
vi /etc/rc.local

ip route flush table net172
ip route add default via 172.31.192.1 dev ens4f0 src 172.31.192.201 table net172
ip rule add from 172.31.192.201 table net172
ip route flush table net10
ip route add default via 10.200.88.1 dev ens9f0 src 10.200.88.201 table net10
ip rule add from 10.200.88.201 table net10
route add default gw 10.200.88.1
```


## 查看路由表
```
route -n

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
169.254.0.0     0.0.0.0         255.255.0.0     U     1006   0        0 ens192
169.254.0.0     0.0.0.0         255.255.0.0     U     1008   0        0 ens224
169.254.0.0     0.0.0.0         255.255.0.0     U     1014   0        0 br-ex
169.254.0.0     0.0.0.0         255.255.0.0     U     1015   0        0 br-int
172.31.192.0    0.0.0.0         255.255.255.0   U     0      0        0 ens192
10.200.88.0    0.0.0.0         255.255.252.0   U     0      0        0 ens224

#在接入测试服务器上验证连通性
ping 172.31.192.201
ping 172.31.196.1

```

